function Resample_Native(hippDir,outdir)
% Reverts resampling applied by Resample_CoronalOblique. Assumes hippDir is
% a subdirectory containing all unfolding files from one subject's left OR
% right hippocampus, with that subject's whole brain data up one directory.

%% load relevant data

load([hippDir '/unfold.mat'])
aff1 = ls([hippDir '/../sub2atlas.*']); % this is expected to be up one directory
aff1(end) = [];
aff2 = ls([hippDir '/../atlas2coronalOblique.*']); % this is expected to be up one directory
aff2(end) = [];
origimg = [hippDir '/../original.nii.gz'];

if contains(hippDir,'hemi-R')
    LR = 'R';
elseif contains(hippDir,'hemi-L')
    LR = 'L';
else
    warning('Could not determine left/right hemisphere; output may be flipped')
    LR = [];
end

%% apply to images
imgList = {'coords-AP','coords-PD','coords-IO',...
    'labelmap-postProcess','subfields-BigBrain'};

for f = 1:length(imgList)
    % TODO: add exception for transforming .vtk back to native (i.e.
    % flipping left image)
    img = ls([hippDir '/' imgList{f} '*.nii.gz']);
    img(end) = [];
    
    if LR == 'R'
        i = load_untouch_nii(img);
        i.img = flip(i.img,1); % flip (only if right)
        mkdir([hippDir '/tmp']); % just to ensure this exists
        save_untouch_nii(i,[hippDir '/tmp/flipping.nii.gz']);
        img = [hippDir '/tmp/flipping.nii.gz'];
    end
    
    system(['antsApplyTransforms -d 3 --interpolation NearestNeighbor '...
        '-i ' img ' '...
        '-o ' outdir '/' imgList{f} '_hemi-' LR '.nii.gz '...
        '-r ' origimg ' '...
        '-t [' aff2 ',1] '...; % reverse the affine
        '-t [' aff1 ',1]']); % reverse the affine
end

%% apply to surfaces

load([hippDir '/surf.mat']);

% Bring vertex coordinates in native space
v = reshape(Vmid,[APres*PDres,3]);
if LR == 'R'
    v(:,1) = sz(1)-v(:,1);
else
    v(:,1) = (v(:,1)-1);
end
v(:,2) = (v(:,2)-1);
v(:,3) = (v(:,3)-1);
ras = [origheader.hdr.hist.srow_x;  origheader.hdr.hist.srow_y; origheader.hdr.hist.srow_z; 0 0 0 1];
v = ras*[v'; ones(1,length(v))];

% load transforms as matrices
i = strfind(aff1,'.');
suffix = aff1(i(end):end);
if strcmp(suffix,'.mat')
    affmat1 = load(aff1);
    affmat1 = reshape(affmat1.AffineTransform_double_3_3,[3,4]);
    affmat1(4,1:4) = [0,0,0,1];
elseif strcmp(suffix,'.txt')
    affmat1 = import_txtAffine(aff1);
    aff1 = itransf.*aff1;
else
    error('Could not load transformation to native space');
end

i = strfind(aff2,'.');
suffix = aff2(i(end):end);
if strcmp(suffix,'.mat')
    aff2 = load(aff2);
    aff2 = reshape(aff2.AffineTransform_double_3_3,[3,4]);
    aff2(4,1:4) = [0,0,0,1];
elseif strcmp(suffix,'.txt')
    aff2 = import_txtAffine(aff2);
else
    error('Could not load transformation back to native space');
end

% appply transforms
% invert
% aff1(1:3,1:3) = aff1(1:3,1:3)';
% aff1(1:3,4) = -aff1(1:3,4);
% aff2(1:3,1:3) = aff2(1:3,1:3)';
% aff2(1:3,4) = -aff2(1:3,4);

v = aff2*v;
v = aff1*v;
Vnative = v';

% Write file
out = [outdir '/midSurf_hemi-' LR '.vtk'];
vtkwrite(out,'polydata','triangle',Vnative(:,1),Vnative(:,2),Vnative(:,3),F);
